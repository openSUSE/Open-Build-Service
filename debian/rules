#!/usr/bin/make -f
#export DH_VERBOSE=1
export DH_OPTIONS

export BUILD_ROOT=$(CURDIR)/debian/tmp

%:
	dh $@ --parallel --with=systemd

override_dh_install:
	# Remove useless backend parts.
	rm -rf debian/tmp/usr/lib/obs/server/build
	rm -rf debian/tmp/etc/apache2/vhosts.d/obs.conf
	rm -f  debian/tmp/usr/share/doc/packages/obs-devel/README.devel
	rm -f  debian/obs-server/usr/lib/obs/server/Makefile.PL
	rm -f  debian/obs-server/usr/lib/obs/server/bs_productconvert

	dh_install --list-missing

        # Do not install database config file in obs-api.
	rm -f  debian/obs-api/usr/share/obs/api/config/database.yml

	dh_installdebconf
	dh_installinit --noscripts --restart-after-upgrade --name obsapidelayed
	dh_installinit --noscripts --restart-after-upgrade --name obsrepserver
	dh_installinit --noscripts --restart-after-upgrade --name obssrcserver
	dh_installinit --noscripts --restart-after-upgrade --name obsdispatcher
	dh_installinit --noscripts --restart-after-upgrade --name obsscheduler@
	dh_installinit --noscripts --restart-after-upgrade --name obswarden
	dh_installinit --noscripts --restart-after-upgrade --name obsdodup
	dh_installinit --noscripts --restart-after-upgrade --name obsservice
	dh_installinit --noscripts --restart-after-upgrade --name obspublisher
	dh_installinit --noscripts --restart-after-upgrade --name obssigner
	dh_installinit --noscripts --name obsworker --no-start
	dh_systemd_enable -p obs-api obsapidelayed.service
	dh_systemd_enable -p obs-server \
		obsrepserver.service \
		obssrcserver.service \
		obsdispatcher.service \
		obswarden.service \
		obsdodup.service \
		obsservice.service \
		obspublisher.service \
		obssigner.service
	dh_systemd_start -p obs-api --restart-after-upgrade \
		obsapidelayed.service
	dh_systemd_start -p obs-server \
		obsrepserver.service \
		obssrcserver.service \
		obsdispatcher.service \
		obswarden.service \
		obsdodup.service \
		obsservice.service \
		obspublisher.service \
		obssigner.service

	# Rename dh_install installed web service config files.
	# (new default since OBS 2.3)
	mkdir -p debian/obs-api/etc/apache2/sites-available/
	cp debian/obs-apache2.conf \
		debian/obs-api/etc/apache2/sites-available/obs.conf

	mkdir -p debian/obs-api/usr/share/dbconfig-common/data/obs-api/install/
	touch debian/obs-api/usr/share/dbconfig-common/data/obs-api/install/mysql
	cp debian/obs-server/usr/lib/obs/server/BSConfig.pm.template \
		debian/obs-server/etc/obs/BSConfig.pm

	# Rename sysconfig file
	mv debian/obs-server/etc/default/sysconfig.obs-server \
		debian/obs-server/etc/default/obs-server

	# these config files must not be hard linked
	install debian/options.yml.example \
		debian/obs-api/usr/share/obs/api/config/options.yml

	# turn duplicates into hard links
	fdupes debian/obs-api/usr/share/obs/

	# Generate log files
	touch debian/obs-api/usr/share/obs/api/log/access.log
	touch debian/obs-api/usr/share/obs/api/log/backend_access.log
	touch debian/obs-api/usr/share/obs/api/log/delayed_job.log
	touch debian/obs-api/usr/share/obs/api/log/error.log
	touch debian/obs-api/usr/share/obs/api/log/lastevents.access.log

override_dh_auto_test:
	 dh_auto_test || true # temporary ignore
