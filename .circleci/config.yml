version: 2.1

images:
  - &common_frontend_config
    user: frontend
    environment:
      NOKOGIRI_USE_SYSTEM_LIBRARIES: 1

  - &mariadb
    image: registry.opensuse.org/obs/server/2.10/containers/containers/openbuildservice/mariadb:210
    command: |
      /bin/bash -c 'echo -e "[mysqld]\ndatadir = /dev/shm" > /etc/my.cnf.d/obs.cnf && cp -a /var/lib/mysql/* /dev/shm && /usr/lib/mysql/mysql-systemd-helper start'
    name: db

  - &backend registry.opensuse.org/obs/server/2.10/containers/containers/openbuildservice/backend:210

  - &frontend_minitest
    image: registry.opensuse.org/obs/server/2.10/containers/containers/openbuildservice/frontend-minitest:210
    <<: *common_frontend_config
    environment:
      EAGER_LOAD: 1

  - &frontend_base
    image: registry.opensuse.org/obs/server/2.10/containers/containers/openbuildservice/frontend-base:210
    <<: *common_frontend_config

  - &frontend_features
    image: registry.opensuse.org/obs/server/2.10/containers/containers/openbuildservice/frontend-features-new:210
    <<: *common_frontend_config

aliases:
  - &restore_bundler_cache
    restore_cache:
      name: Restoring Bundle Cache
      key: bundle-{{ checksum "src/api/Gemfile.lock" }}

  - &install_dependencies
    name: install dependencies
    command: |
      cd src/api
      # TODO: Keep build options in sync with obs-bundled-gems.spec
      bundle config build.ffi --enable-system-libffi
      bundle config build.nokogiri --use-system-libraries
      bundle config build.nio4r --with-cflags='-Wno-return-type'
      bundle config force_ruby_platform true
      bundle config set --local path 'vendor/bundle'
      bundle install --jobs=4 --retry=3 --local

  - &save_bundler_cache
    save_cache:
      name: Saving Bundle Cache
      key: bundle-{{ checksum "src/api/Gemfile.lock" }}
      paths:
        - "src/api/vendor/bundle"

  - &init_git_submodule
    name: Init submodule
    command: git submodule update --init --recursive --remote

  - &create_test_db
    name: Create database
    working_directory: src/api
    command: bundle exec rake db:create db:setup RAILS_ENV=test

  - &bootstrap_old_test_suite
    name: Setup application
    working_directory: src/api
    command: bundle exec rake dev:bootstrap[old_test_suite] RAILS_ENV=test FORCE_EXAMPLE_FILES=1

  - &compress_log_artifacts
    name: Compress Log Artifacts
    working_directory: src/api/log
    command: for i in *.log; do xz -T 0 -v $i; done
    when: always

  - &compress_capybara_artifacts
    name: Compress Capybara Artifacts
    command: |
      # The directory might not exist if nothing failed...
      mkdir -p src/api/tmp/capybara
      cd src/api/tmp/capybara
      export NUMBER_OF_FAILED_TESTS=`ls -1|wc -l`
      # Only compress if there are more than 20 tests failed...
      if test $NUMBER_OF_FAILED_TESTS -gt 40; then mkdir capybara; mv  -v *.png *.html capybara; tar cvJf capybara.tar.xz capybara; rm -rf capybara; fi
    when: always

  - &install_circle_cli
    name: Install CircleCI command line
    command: |
      curl -o circleci https://circle-downloads.s3.amazonaws.com/releases/build_agent_wrapper/circleci
      chmod +x circleci

  - &restore_rubocop_cache
    restore_cache:
      name: Restoring Rubocop Cache
      key: rubocop-{{ .Branch }}-{{ checksum "./src/api/Gemfile.lock" }}

  - &save_rubocop_cache
    save_cache:
      name: Saving Rubocop Cache
      key: rubocop-{{ .Branch }}-{{ checksum "./src/api/Gemfile.lock" }}
      paths:
        - src/api/tmp/rubocop_cache_root_dir
        - src/api/tmp/rubocop_cache_rails_dir

jobs:
  checkout_code:
    docker:
      - <<: *frontend_base
    steps:
      - checkout
      - *restore_bundler_cache
      - *restore_rubocop_cache
      - run: *install_dependencies
      - *save_bundler_cache
      - run: *install_circle_cli
      - run:
          name: Setup application
          working_directory: src/api
          command: bundle exec rake dev:prepare assets:precompile RAILS_ENV=test FORCE_EXAMPLE_FILES=1
      - persist_to_workspace:
          root: .
          paths:
            - .

  linters:
    docker:
      - <<: *frontend_base
      - <<: *mariadb
    steps:
      - attach_workspace:
         at: .
      - run:
          name: Run brakeman
          command: |
            sudo gem install --no-format-executable brakeman --version 5.0.2
            brakeman --rails6 -p src/api
      - run:
          name: Run jshint
          working_directory: src/api
          command: |
            sudo npm install -g jshint
            jshint app/assets/javascripts
      - run:
          name: Run HAML linter
          working_directory: src/api
          command: bundle exec rake dev:lint:haml
      - run:
          name: Run rubocop
          working_directory: src/api
          command: bundle exec rake dev:lint:rubocop:all
      - *save_rubocop_cache

  rspec:
    parallelism: 3
    docker:
      - <<: *frontend_base
      - <<: *mariadb
    steps:
      - attach_workspace:
         at: .
      - run: *create_test_db
      - run: mkdir /home/frontend/rspec
      - run:
          name: Run rspec
          working_directory: src/api
          command: |
            pickfile=log/pick.$CIRCLE_NODE_INDEX.list
            circleci tests glob 'spec/**/*_spec.rb' | grep -v 'spec/\(features\|db\)' > spec.list
            circleci tests split --total $CIRCLE_NODE_TOTAL --split-by=timings < spec.list > $pickfile
            bundle exec rspec --format documentation --format RspecJunitFormatter -o /home/frontend/rspec/rspec.xml $(cat $pickfile)
            # run DB tests at the end of node 0
            # see https://github.com/openSUSE/open-build-service/issues/4959
            if test "$CIRCLE_NODE_INDEX" = 0; then
              echo "Running data migration tests"
              # simulating parallel tests - otherwise one rspec call overwrites the previous
              export TEST_ENV_NUMBER=2
              export PARALLEL_TEST_GROUPS="RSpec"
              bundle exec rspec --format documentation --format RspecJunitFormatter \
                -o /home/frontend/rspec/rspec.db.xml $(circleci tests glob 'spec/db/**/*_spec.rb')
            fi
            mkdir coverage_results
            cp -R coverage/.resultset.json coverage_results/resultset-rspec-${CIRCLE_NODE_INDEX}.json
      - persist_to_workspace:
          root: .
          paths:
            - src/api/coverage_results
      - store_test_results:
          path: /home/frontend/rspec
      - run: *compress_log_artifacts
      - store_artifacts:
          path: ./src/api/log
          destination: log

  minitest:
    parallelism: 2
    docker:
      - <<: *frontend_minitest
      - <<: *mariadb
    steps:
      - attach_workspace:
         at: .
      - run: *init_git_submodule
      - run: *bootstrap_old_test_suite
      - run: mkdir /home/frontend/minitest
      - run:
          name: Run minitest
          environment:
            DO_COVERAGE: 1
            TESTOPTS: "--ci-dir=/home/frontend/minitest"
          working_directory: src/api
          command: |
            case $CIRCLE_NODE_INDEX in
              0)
                bundle exec rake test:api:group1
                ;;
              1)
                bundle exec rake test:api:group2
                ;;
            esac
            mkdir coverage_results
            cp -R coverage/.resultset.json coverage_results/resultset-minitest-${CIRCLE_NODE_INDEX}.json
      - persist_to_workspace:
          root: .
          paths:
            - src/api/coverage_results
      - store_test_results:
          path: /home/frontend/minitest
      - run: *compress_log_artifacts
      - store_artifacts:
          path: ./src/api/log/
          destination: log

  migrations_tests:
    docker:
      - <<: *frontend_base
      - <<: *mariadb
    steps:
      - attach_workspace:
         at: .
      - run: *init_git_submodule
      - run:
          name: Run migrations
          working_directory: src/api
          command: |
            bundle exec rake db:drop
            bundle exec rake db:create
            bundle exec rake db:migrate:with_data
            bundle exec rake db:seed

  spider:
    parallelism: 2
    docker:
      - <<: *frontend_features
      - <<: *mariadb
    steps:
      - attach_workspace:
         at: .
      - run: *init_git_submodule
      - run: *bootstrap_old_test_suite
      - run:
          name: Run spider
          working_directory: src/api
          command: |
            case $CIRCLE_NODE_INDEX in
              0)
                bundle exec rails test test/functional/webui/spider_test.rb -n test_spider_anonymously
                ;;
              1)
                bundle exec rails test test/functional/webui/spider_test.rb -n test_spider_as_admin
                ;;
            esac
      - run:
          name: Loading the application in production
          command: |
            bundle exec rake secret > config/secret.key
            DISABLE_DATABASE_ENVIRONMENT_CHECK=1 RAILS_ENV=production bundle exec rake db:setup zeitwerk:check
            rm config/secret.key
      - run: *compress_log_artifacts
      - store_artifacts:
          path: ./src/api/log/
          destination: log

  backend_test:
    docker:
      - image: *backend
    working_directory: /home/frontend/project
    steps:
      - checkout
      - run: *init_git_submodule
      - run:
          name: backend
          command: make -C src/backend test

  coverage:
    docker:
      - <<: *frontend_base
    steps:
      - attach_workspace:
         at: .
      - run:
          name: Merge coverage
          working_directory: src/api
          command: bundle exec rake ci:simplecov_ci_merge
      - run:
          name: Upload coverage to codecov
          working_directory: src/api
          command: |
            curl -LOs https://uploader.codecov.io/latest/linux/codecov
            chmod +x codecov
            ./codecov -v -f coverage/coverage.xml
      - run:
          name: Upload coverage to codeclimate
          working_directory: src/api
          environment:
            CC_TEST_REPORTER_ID: 4969e47d48f3745fa39d4d9d717e5da88bc3e42376d665c54ba313ae3ce3189c
          command: |
            curl -LOs https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64
            chmod +x test-reporter-latest-linux-amd64
            ./test-reporter-latest-linux-amd64 format-coverage --add-prefix src/api/ coverage/coverage.xml -t cobertura
            ./test-reporter-latest-linux-amd64 upload-coverage
      - run:
          name: Compress coverage results
          working_directory: src/api
          command: |
            tar cvJf coverage_results.tar.xz coverage_results/*
      - store_artifacts:
          path: src/api/coverage_results.tar.xz

  feature:
    parallelism: 2
    docker:
      - <<: *frontend_features
      - <<: *mariadb
    resource_class: large
    steps:
      - attach_workspace:
         at: .
      - run: *create_test_db
      - run:
          name: Run rspec feature tests
          working_directory: src/api
          command: |
            if test "$CIRCLE_NODE_INDEX" = 0; then
              message="Running feature tests for desktop"
            else
              message="Running feature tests for mobile"
              export CAPYBARA_DRIVER='mobile'
            fi
            echo $message
            mkdir /home/frontend/feature
            bundle exec rake webdrivers:geckodriver:update
            bundle exec rspec --format documentation --format RspecJunitFormatter -o /home/frontend/feature/feature.xml spec/features/
            mkdir coverage_results
            cp -R coverage/.resultset.json coverage_results/resultset-feature-${CIRCLE_NODE_INDEX}.json
      - persist_to_workspace:
          root: .
          paths:
            - src/api/coverage_results
      - store_test_results:
          path: /home/frontend/feature
      - run: *compress_log_artifacts
      - store_artifacts:
          path: ./src/api/log
          destination: log
      - run: *compress_capybara_artifacts
      - store_artifacts:
          path: ./src/api/tmp/capybara
          destination: capybara

workflows:
  version: 2

  migration_tests:
    jobs:
      - checkout_code
      - migrations_tests:
          requires:
            - checkout_code

  backend_tests:
    jobs:
      - backend_test

  test_all:
    jobs:
      - checkout_code
      - linters:
          requires:
            - checkout_code
      - rspec:
          requires:
            - linters
      - minitest:
          requires:
            - linters
      - spider:
          requires:
            - rspec
            - minitest
            - feature
      - coverage:
          requires:
            - rspec
            - minitest
            - feature
      - feature:
          requires:
            - linters
