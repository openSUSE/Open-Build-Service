 <%
   problems = project.failed_status_checks.map do |check|
     content_tag(:li) do
       link_to check.name, check.url, class: "check-#{check.state}", title: "#{check.short_description} (#{check.updated_at})"
     end
   end
-%>

<%# Failed packages are grouped by name %>
<% failed_packages = {} %>
<% other_broken_packages = [] %>
<% project.broken_packages.each do |pack|
  name = pack['package']
  if pack['state'] == 'failed'
    version = {arch: pack['arch'], project: pack['project']}
    if failed_packages[name]
      failed_packages[name][:versions] << version
    else
      failed_packages[name] = {repository: pack['repository'], versions: [version]}
    end
  else
    other_broken_packages << {name: pack['package'], state: pack['state'], project: pack['project'] }
  end
end -%>

<% problems += failed_packages.map do |name, attrs|
  versions = attrs[:versions].map do |v|
    link_to(v[:arch], package_live_build_log_url(v.merge(package: name, repository: attrs[:repository])))
  end
  label = "Build failed #{name} (" + versions.join(", ") + ")"
  content_tag(:li, label.html_safe, class: "failed_pkg status_failed")
end -%>

<% problems += other_broken_packages.map do |pack|
  st = pack[:state]
  name = pack[:name]
  label = "Build #{st}: #{name}"
  content_tag(:li, link_to(label.html_safe, package_show_url(pack[:project], name)), class: "failed_pkg status_#{st}")
end -%>

<% if problems.empty? %>
  <i class='fa-check-circle fa fa-2x ok-checkbox'></i>
<% else %>
  <ul class='problem_list'>
    <%- problems.sort! -%>
    <%- num_elements = 6 -%>
    <%- count = problems.size -%>
    <% problems[0, num_elements - 1].each do |p| %>
      <%= p %>
    <% end %>
    <% if count > num_elements # Prevent the "1 more" link %>
      <%- name = project.letter %>
      <li>
        <%= link_to "...#{count - (num_elements - 1)} more problems", "#", class: "staging_expand staging_#{name}", data: {name: name} %>
      </li>
      <div class="staging_collapsible staging_<%= name %>" style="display:none">
        <% problems[(num_elements - 1)..-1].each do |p| %>
          <%= p %>
        <% end %>
        <li>
          <%= link_to "collapse", "#", class: "staging_collapse staging_#{name}", data: {name: name} %>
        </li>
      </div>
    <% end %>
  </ul>
<% end %>
