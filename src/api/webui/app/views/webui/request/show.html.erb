<% @pagetitle = "Request #{@id}" %>
<% @layouttype = 'custom' %>
<% @crumb_list = ["Request #{@id}"] %>

<%= content_for :ready_function do %>
    $('#description').expander({slicePoint: 300, expandText: '[+]', expandPrefix: ' ', userCollapseText: '[-]',});
<% end %>

<div id="request_navigation_box" style="position: absolute; right: 0.3em;">
  <% if @request_before -%>
      <%= link_to "<<", :controller => :request, :action => :show, id: @request_before %>
  <% end -%>
  <% if @request_after -%>
      <%= link_to ">>", :controller => :request, :action => :show, id: @request_after %>
  <% end -%>
</div>

<div class="grid_16 alpha omega box box-shadow">
  <%= render :partial => 'tabs' %>
  <div class="grid_10 alpha">
    <h3><%= @pagetitle %> (<%= @state %>)</h3>
    <%= description_wrapper(@req['description']) %>
  </div>
  <div class="grid_6 omega">
    <ul class="clean_list">
      <li><%= sprite_tag('user_green') %> Created
        by <%= render :partial => 'shared/user_with_realname_and_icon', :locals => { :user => @req['creator'], :no_icon => true, :short => true } %> <%= fuzzy_time(@req['created_at']) %></li>
      <li><%= sprite_tag('information') %> In
        state <%= link_to @state, { :anchor => "request_history" }, { :style => "color: #{request_state_color(@state)};" } %></li>
      <% if @superseded_by %>
          <li><%= sprite_tag('exclamation') %> Superseded by <%= link_to @superseded_by, id: @superseded_by %></li>
      <% end %>
      <% if @accept_at -%>
          <li><%= sprite_tag('exclamation') %> This request will get accepted after <%= @accept_at %> automatically!</li>
      <% end -%>
      <% if @other_open_reviews.length > 0 %>
          <% @other_open_reviews.each do |review| %>
              <li>
                <%= sprite_tag('exclamation') %> Open review for
                <%= render :partial => 'reviewer', :locals => { :review => review } %>
              </li>
          <% end %>
      <% end %>
    </ul>
  </div>
</div>

<div class="grid_16 alpha omega box box-shadow">
  <% if @actions.length > 1 %>
      <div class="box-header header-tabs">
        <ul id="action_select">
          <% @actions.each_with_index do |action, index| %>
              <li class="<%= 'selected' if index == 0 %>">
                <a class="action_select_link" id="action_select_link_<%= index %>" href="#"><%= action[:name] %></a>
              </li>
          <% end %>
        </ul>
      </div>
      <%= content_for :ready_function do %>
          $('.action_select_link').click(function (event) {
          $('#action_select li.selected').attr('class', '');
          $(event.target).parent().attr('class', 'selected')
          $('.action_display').hide();
          index = event.target.id.split('action_select_link_')[1]
          $('#action_display_' + index).show();
          return false;
          });
      <% end %>
  <% end %>
  <% @actions.each_with_index do |action, action_index| %>
      <div class="action_display" style="<%= 'display: none;' if action_index > 0 %>" id="action_display_<%= action_index %>">
        <p>
          <% if action[:type] == :submit %>
              <b>Submit
                <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:sprj], package: action[:spkg], :rev => action[:srev] } %>
                to
                <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:tprj], package: action[:tpkg] } %>
              </b>
              <% if @can_handle_request && @is_target_maintainer %>
                  <% if !action[:creator_is_target_maintainer] %>
                      <%# TODO: Make this work for each submit action individually: %>
                      <br/><%= check_box_tag("add_submitter_as_maintainer_#{action_index}", "#{action[:tprj]}_#_#{action[:tpkg]}", false, :class => 'submitter_is_maintainer_checkbox') %>
                      Add
                      <%= render :partial => 'shared/user_with_realname_and_icon', :locals => { :user => @req['creator'], :no_icon => true, :short => true } %>
                      as maintainer for
                      <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:tprj], package: action[:tpkg], :short => true } %>
                  <% end %>

                  <% if action[:forward] %>
                      <%# TODO: Make this work for each submit action individually: %>
                      <% action[:forward].each do |forward| %>
                          <% index = 0 %>
                          <% if forward[:type] == 'link' %>
                              <br/><%= check_box_tag('forward_link', "#{forward[:project]}_#_#{forward[:package]}", false, :class => 'forward_checkbox') %>
                              Forward to linked package
                              <%= render :partial => 'shared/project_or_package_link', :locals => { project: forward[:project], package: forward[:package], :short => true } %>
                              <br/>
                          <% else %>
                              <br/><%= check_box_tag("forward_devel_#{index}", "#{forward[:project]}_#_#{forward[:package]}", true, :class => 'forward_checkbox') %>
                              Forward to developed package
                              <%= render :partial => 'shared/project_or_package_link', :locals => { project: forward[:project], package: forward[:package], :short => true } %>
                              <br/>
                              <% index += 1 %>
                          <% end %>
                      <% end %>
                  <% end %>
              <% end %>

          <% elsif action[:type] == :delete %>
              <b>Delete
                <% if action[:trepo] %>
                    repository <%= link_to action[:trepo], :controller => :project, :action => :repositories, :project => action[:tprj], :repository => action[:trepo] %>
                    in
                <% end %>
                <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:tprj], package: action[:tpkg] } %>
              </b>
          <% elsif action[:type] == :add_role %>
              <b>
                <%= render :partial => 'shared/user_with_realname_and_icon', :locals => { :user => User.find_by_login(action[:user]) } %>
                wants the role <b><%= action[:role] %></b> for
                <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:tprj], package: action[:tpkg] } %>
              </b>
          <% elsif action[:type] == :change_devel %>
              <b>
                Set the devel project to
                <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:sprj], package: action[:spkg] } %>
                for
                <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:tprj], package: action[:tpkg] } %>
              </b>
          <% elsif action[:type] == :maintenance_incident %>
              <b>
                Submit update from
                <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:sprj], package: action[:spkg], :homeproject => @req['creator'] } %>
                to
                <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:tprj], package: action[:tpkg] } %>
              </b>
              <% if action[:releaseproject] %>
                  <br/><i>
          Release in
          <%= action[:releaseproject] %>
        </i>
              <% end %>
          <% elsif action[:type] == :maintenance_release %>
              <b>
                Release
                <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:sprj], package: action[:spkg] } %>
                to
                <%= render :partial => 'shared/project_or_package_link', :locals => { project: action[:tprj], package: action[:tpkg] } %>
              </b>
          <% end %>
        </p>

        <% if action[:sourcediff] %>
            <% action[:sourcediff].each_with_index do |sourcediff, sourcediff_index| %>
                <div class="grid_10 alpha">
                  <% if sourcediff[:error] %>
                      <%= content_tag(:p, content_tag(:i, sourcediff[:error], class: :error)) %>
                  <% else %>
                      <% if action[:type] == :delete
                           t = sourcediff['old']
                         else
                           t = sourcediff['new']
                         end
                         project, package, rev = t['project'], t['package'], t['rev'] %>

                      <% if action[:sourcediff].length != 1 %>
                          <h4>
                            <%= sourcediff['new']['project'] %> / <%= sourcediff['new']['package'] %>
                            (rev <%= sourcediff['new']['rev'] %>) -
                            <%= sourcediff['old']['project'] %> / <%= sourcediff['old']['package'] %>
                            (rev <%= sourcediff['old']['rev'] %>)
                          </h4>
                      <% end %>
                      <%#TODO: Redo source/target link display %>
                      <%= render(:partial => 'shared/sourcediff', locals: { filenames: sourcediff['filenames'], files: sourcediff['files'], :source => { project: project, package: package, :rev => rev }, :css_id => "diff_action_#{action_index}_#{action[:type]}_#{sourcediff_index}", :editor_width => '550px' }) %>
                  <% end %>
                </div>
                <div class="grid_6 omega">
                  <%#= render :partial => 'shared/buildresult_box', locals: { project: project, package: package, index: action_index } %>
                  <% if sourcediff['issues'] && sourcediff['issues'].length > 0 %>
                      <p><b>Mentioned Issues (<%= sourcediff['issues'].length %>)</b></p>
                      <%= render partial: 'issues_table', locals: { issues: sourcediff['issues'] } %>
                  <% end %>
                </div>
            <% end %>
        <% end %>
      </div>
  <% end %>
</div>

<div class="grid_16 alpha omega">
  <div class="grid_10 alpha">
    <div class="box box-shadow">
      <% if @can_add_reviews || @can_handle_request %>
          <div class="box-header header-tabs">
            <ul id="review_descision_select">
              <% if @can_handle_request %>
                  <li class="<%= 'selected' if !@can_add_reviews || @my_open_reviews.length == 0 %>">
                    <a class="review_descision_link" id="review_descision_link_-1" href="#">My Decision</a>
                  </li>
              <% end %>
              <% if @can_add_reviews && @my_open_reviews.length > 0 %>
                  <% @my_open_reviews.each_with_index do |open_review, index| %>
                      <li class="<%= 'selected' if @my_open_reviews.length > 0 && index == 0 %>">
                        <a class="review_descision_link" id="review_descision_link_<%= index %>" href="#">Review
                          for <%= render :partial => 'reviewer', :locals => { :review => open_review, :no_link => true, :no_icon => true } %></a>
                      </li>
                  <% end %>
              <% end %>
            </ul>
            <% content_for :ready_function do %>
                requestShowReview();
            <% end %>
          </div>
          <div class="review_descision_display" style="<%= 'display: none;' if @can_add_reviews && @my_open_reviews.length > 0 %>" id="review_descision_display_-1">
            <% if @can_add_reviews %>
              <span style="float: right;">
                <%= link_to(sprite_tag('user_add', title: 'Add a review') + 'Add a review', { controller: 'request', action: 'add_reviewer_dialog', id: @id }, remote: true) %>
              </span>
            <% end %>
            <% if @can_handle_request %>
                <%= form_tag({ :action => 'changerequest' }, { id: 'request_handle_form' }) do %>
                    <p><%= text_area_tag(:reason, 'Please add a comment', :size => '80x2', :style => 'width: 99%') %></p>

                    <p>
                      <%= hidden_field_tag(:id, @id) %>
                      <% if ['new', 'review'].include?(@state) && @is_target_maintainer %>
                          <% if @state == 'review' %>
                              <%= submit_tag 'Accept request', name: 'accepted', id: 'accept_request_button', :confirm => 'Do you really want to approve this request, despite of open review requests?' %>
                          <% else %>
                              <%= submit_tag 'Accept request', name: 'accepted', id: 'accept_request_button' %>
                          <% end %>
                          <%= submit_tag 'Decline request', name: 'declined' if !@is_author %>
                      <% end %>
                      <% if ['new', 'review', 'declined'].include?(@state) && @is_author %>
                          <%= submit_tag 'Revoke request', name: 'revoked' , id: 'revoke_request_button' %>
                      <% end %>
                      <% if @state == 'declined' %>
                          <%= submit_tag 'Reopen request', name: 'new', id: 'reopen_request_button' %>
                      <% end %>
                      <span style="float: right;">
                        <% if reqtype(@req['actions'].first) == 'incident' %>
                            <%= link_to(sprite_tag('package_link', title: 'Merge with existing incident') + 'Merge with existing incident', { :controller => 'request', :action => 'set_incident_dialog', id: @id }, :remote => true) %>
                        <% end %>
                      </span>
                    </p>
                <% end %>
                <% content_for :ready_function do %>
                    requestAddAcceptRequestButton();
                <% end %>
            <% end %>
          </div>
          <% if @can_add_reviews && @my_open_reviews.length > 0 %>
              <% @my_open_reviews.each_with_index do |review, index| %>
                  <div class="review_descision_display <%= 'hidden' if index != 0 %>" id="review_descision_display_<%= index %>">
                    <%= form_tag(:action => "modify_review") do %>
                        <p><%= text_area_tag("review_comment_#{index}", review[:reason], :size => '80x2', :style => "width: 99%", :class => 'review_comment') %></p>

                        <p>
                          <%= hidden_field_tag("review_request_id_#{index}", @id) %>
                          <%= hidden_field_tag("review_by_user_#{index}", review[:by_user]) if review[:by_user] %>
                          <%= hidden_field_tag("review_by_group_#{index}", review[:by_group]) if review[:by_group] %>
                          <%= hidden_field_tag("review_by_project_#{index}", review[:by_project]) if review[:by_project] %>
                          <%= hidden_field_tag("review_by_package_#{index}", review[:by_package]) if review[:by_package] %>
                          <%= submit_tag 'Accept review', name: 'accepted', id: "review_accept_button_#{index}" %>
                          <%= submit_tag 'Decline review', name: 'declined', id: "review_decline_button_#{index}" %>
                        </p>
                    <% end %>
                  </div>
              <% end %>
          <% end %>
          <% content_for :ready_function do %>
              $('.review_comment, #reason').click(function () { $(this).text(''); });
          <% end %>
      <% else %>
          <p><i>There's nothing to be done right now</i></p>
      <% end %>
    </div>
  </div>

  <div class="grid_6 omega">
    <div class="box box-shadow" id="request_history">
      <h2 class="box-header">Request History</h2>
      <%# TODO: Replace with reviews listing only, nobody cares for the history %>
      <%= render :partial => 'recent_events_table' %>
    </div>
  </div>
</div>

<div class="grid_16 box box-shadow alpha omega" style="margin-top: 15px;">
  <h2 class="box-header">Comments for request <%= @id %> (<%= @comments.length %>)</h2>
  <%= render :partial => "webui/comment/show"%>
</div>
